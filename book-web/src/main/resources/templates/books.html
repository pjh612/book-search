<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>도서 목록</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/books.css">
  <script src="/js/auth-fetch.js"></script>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>도서 목록</h1>
      <form id="searchForm" class="search-form">
        <input id="keyword" class="input" type="text" name="keyword" placeholder="책 제목 검색" th:value="${keyword}" />
        <button type="submit">검색</button>
        <button type="button" class="ghost" id="resetBtn">초기화</button>
      </form>
      <a class="ghost-link" href="/signin">로그인</a>
    </div>

    <div id="hotKeywords" class="hot-keywords" aria-live="polite">
      <span class="label">인기 검색어</span>
      <div id="kwList" class="kw-list"></div>
    </div>

    <div id="message" class="msg"></div>

    <div class="grid" id="list"></div>
    <!-- 무한스크롤 관찰 지점 -->
    <div id="infiniteSentinel" aria-hidden="true"></div>

    <div class="pager">
      <button id="prevBtn" class="ghost">이전</button>
      <span id="pageInfo"></span>
      <button id="nextBtn" class="ghost">다음</button>
    </div>
  </div>

  <script>
    (function(){
      const PLACEHOLDER_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="300" height="400" viewBox="0 0 300 400">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#eef2ff"/>
              <stop offset="100%" stop-color="#e5e7eb"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <g fill="#9ca3af" transform="translate(75,110)">
            <rect x="0" y="0" width="150" height="180" rx="8" ry="8" fill="#d1d5db"/>
            <path d="M15 30h120v8H15zM15 55h120v8H15zM15 80h100v8H15z"/>
          </g>
          <text x="50%" y="90%" dominant-baseline="middle" text-anchor="middle" fill="#6b7280" font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial" font-size="16">
            No Cover Image
          </text>
        </svg>
      `);

      // Elements
      const listEl = document.getElementById('list');
      const msgEl = document.getElementById('message');
      const formEl = document.getElementById('searchForm');
      const kwEl = document.getElementById('keyword');
      const resetBtn = document.getElementById('resetBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');
      const hotWrap = document.getElementById('hotKeywords');
      const kwListEl = document.getElementById('kwList');
      const sentinel = document.getElementById('infiniteSentinel');
      const pager = document.querySelector('.pager');

      // State
      const state = {
        mode: 'all',                 // 'all' | 'search'
        keyword: (kwEl && kwEl.value) || '',
        size: 24,
        // cursor mode
        cursor: null,
        hasMore: true,
        loading: false,
        // page mode (for search only)
        page: 0,
        totalPages: 0,
        totalElements: 0
      };

      // Helpers
      function setMsg(text, type){
        if (!msgEl) return;
        msgEl.textContent = text || '';
        msgEl.className = 'msg' + (type ? ' ' + type : '');
      }
      function fmtDate(v){ try{ return v ? new Date(v).toLocaleDateString() : ''; }catch{ return v || ''; } }

      function createCard(b){
        const card = document.createElement('div'); card.className = 'card';
        const a = document.createElement('a'); a.href = `/books/${b.id}`; a.title = '상세보기';
        const img = document.createElement('img'); img.className = 'thumb'; img.alt = '표지';
        const imgSrc = (b && typeof b.image === 'string' && b.image.trim()) ? b.image : PLACEHOLDER_IMG;
        img.src = imgSrc; img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER_IMG; };
        const body = document.createElement('div'); body.className = 'card-body';
        const t = document.createElement('h3'); t.className = 'title'; t.textContent = b.title || '(제목 없음)';
        const m = document.createElement('p'); m.className = 'meta'; m.textContent = [b.author, b.publisher, fmtDate(b.published)].filter(Boolean).join(' · ');
        body.appendChild(t); body.appendChild(m); a.appendChild(img); a.appendChild(body); card.appendChild(a);
        return card;
      }

      function clearList(){ if (listEl) listEl.innerHTML = ''; }
      function appendItems(items){
        if (!listEl) return;
        const frag = document.createDocumentFragment();
        (items || []).forEach(b => frag.appendChild(createCard(b)));
        listEl.appendChild(frag);
      }

      function togglePager(show){ if (pager) pager.style.display = show ? '' : 'none'; }
      function toggleSentinel(show){ if (sentinel) sentinel.style.display = show ? '' : 'none'; }

      function renderPager(){
        pageInfo.textContent = state.totalPages ? `${state.page+1} / ${state.totalPages}` : '';
        prevBtn.disabled = state.page <= 0;
        nextBtn.disabled = state.page + 1 >= state.totalPages;
      }

      async function fetchJSON(url){
        console.log('Fetching:', url);
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(await res.text() || '요청 실패');
        return res.json();
      }

      // ============== Cursor mode (all) ==============
      let io = null;
      function setupObserver(){
        if (!sentinel) return;
        if (io) io.disconnect();
        io = new IntersectionObserver(async (entries)=>{
          const entry = entries[0];
          if (!entry.isIntersecting) return;
          if (state.loading || !state.hasMore || state.mode !== 'all') return;
          await loadMoreCursor();
        }, { root: null, rootMargin: '0px 0px 400px 0px', threshold: 0 });
        io.observe(sentinel);
      }
      function disconnectObserver(){ if (io){ io.disconnect(); io = null; } }

      async function loadMoreCursor(){
        if (state.loading) return;
        state.loading = true;
        try{
          let url = `/api/books/cursor?size=${state.size}`;
          if (state.cursor) {
            url += `&cursor=${encodeURIComponent(state.cursor)}`;
          }
          const data = await fetchJSON(url);
          const items = data.items || [];
          if (items.length === 0){
            state.hasMore = false;
            toggleSentinel(false);
            if (!state.cursor) setMsg('표시할 도서가 없습니다.');
            return;
          }
          appendItems(items);
          setMsg('');
          state.cursor = data.cursor || null;
          state.hasMore = Boolean(state.cursor);
          toggleSentinel(state.hasMore);
        }catch(err){
          console.warn(err);
          setMsg(err.message || '불러오기 실패', 'error');
        }finally{
          state.loading = false;
        }
      }

      async function initCursorMode(){
        // UI 전환
        togglePager(false);
        toggleSentinel(true);
        disconnectObserver();
        setupObserver();

        // 상태 초기화
        state.cursor = null;
        state.hasMore = true;
        state.loading = false;
        clearList();
        setMsg('불러오는 중...');
        await loadMoreCursor();
      }

      // ============== Page mode (search) ==============
      async function loadAll(){ /* deprecated: cursor 모드로 대체 */ return initCursorMode(); }

      async function doSearch(){
        const q = (state.keyword || '').trim();
        if (!q){ state.mode = 'all'; return initCursorMode(); }
        // 검색 모드: 페이지 기반 유지, 무한스크롤 비활성
        toggleSentinel(false);
        disconnectObserver();
        togglePager(true);

        setMsg('검색 중...');
        try{
          const data = await fetchJSON(`/api/books/search?keyword=${encodeURIComponent(q)}&page=${state.page}&size=${state.size}`);
          const items = data.books || [];
          const p = data.pageInfo || {};
          state.totalPages = p.totalPages || 0;
          state.totalElements = p.totalElements || (items ? items.length : 0);
          clearList();
          if (!items.length){ setMsg('검색 결과가 없습니다.'); }
          else { appendItems(items); setMsg(`'${q}' 검색 결과 ${state.totalElements}건`); }
          renderPager();
        }catch(err){ setMsg(err.message || '검색 실패', 'error'); }
      }

      // ============== Hot Keywords ==============
      async function loadHotKeywords(){
        if (!kwListEl || !hotWrap) return;
        try{
          const data = await fetchJSON(`/api/hot-keywords`);
          const keywords = (data && data.keywords) ? data.keywords : (Array.isArray(data) ? data : []);
          kwListEl.innerHTML = '';
          if (!keywords.length){ hotWrap.style.display = 'none'; return; }
          hotWrap.style.display = '';
          const frag = document.createDocumentFragment();
          keywords.forEach((kw, i)=>{
            const btn = document.createElement('button');
            btn.type = 'button'; btn.className = 'kw-chip';
            const rank = document.createElement('span'); rank.className = 'kw-rank'; rank.textContent = String(i+1);
            const text = document.createElement('span'); text.textContent = ` ${kw}`;
            btn.appendChild(rank); btn.appendChild(text);
            btn.addEventListener('click', ()=>{
              if (kwEl) kwEl.value = kw;
              state.keyword = kw; state.page = 0; state.mode = 'search';
              doSearch();
            });
            frag.appendChild(btn);
          });
          kwListEl.appendChild(frag);
        }catch(err){ console.warn('인기 검색어 로드 실패', err); hotWrap.style.display = 'none'; }
      }

      // ============== Events ==============
      if (formEl){
        formEl.addEventListener('submit', (e)=>{
          e.preventDefault();
          state.keyword = kwEl ? kwEl.value : '';
          state.page = 0;
          state.mode = state.keyword ? 'search' : 'all';
          state.mode === 'search' ? doSearch() : initCursorMode();
        });
      }

      if (resetBtn){
        resetBtn.addEventListener('click', ()=>{
          if (kwEl) kwEl.value = '';
          state.keyword = '';
          state.page = 0;
          state.mode = 'all';
          initCursorMode();
        });
      }

      prevBtn.addEventListener('click', ()=>{ if(state.page>0){ state.page--; doSearch(); } });
      nextBtn.addEventListener('click', ()=>{ if(state.page+1<state.totalPages){ state.page++; doSearch(); } });

      // ============== Init ==============
      loadHotKeywords();
      if ((state.keyword || '').trim()) { state.mode='search'; togglePager(true); toggleSentinel(false); doSearch(); }
      else { state.mode='all'; togglePager(false); initCursorMode(); }
    })();
  </script>
</body>
</html>